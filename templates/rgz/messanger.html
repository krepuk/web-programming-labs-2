{% extends "base_rgz.html" %}

{% block main %}
<div id="messenger-container">
        <div id="user-list">
            <h3>Пользователи</h3>
            <ul id="users">
            </ul>
        </div>

        <div id="chat-box">
            <h3 id="chat-title">Выберите пользователя для чата</h3>
            <div id="messages">
            </div>
            <div>
                <input id="message-input" type="text" placeholder="Введите сообщение...">
                <button id="send-message">Отправить</button>
            </div>
        </div>

        <div id="user-info">
            <h3>Добро пожаловать, <span id="username-display">{{ username }}</span></h3>
            <button id="logout-button">Выйти</button>
        </div>
    </div>

    {%block script%}
    <script>
        let currentChatUser = null; 

        function fetchUsers() {
            fetch('/api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'get_users',
                    params: {},
                    id: 3
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && data.result.users) {
                    const userList = document.getElementById('users');
                    userList.innerHTML = ''; 

                    data.result.users.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user.login;
                        li.style.cursor = 'pointer';
                        li.onclick = function() {
                            openChat(user.login);
                        };
                        userList.appendChild(li);
                    });
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке пользователей:', error);
            });
        }

        function openChat(selectedUser) {
            currentChatUser = selectedUser; 
            const chatTitle = document.getElementById('chat-title');
            chatTitle.textContent = `Чат с ${selectedUser}`;

            loadMessages(selectedUser);
        }
        function loadMessages(selectedUser) {
            fetch('/json-rpc-api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'get_messages',  
                    params: { 
                        sender: '{{ username }}',  
                        receiver: selectedUser     
                    },
                    id: 4
                })
            })
            .then(response => response.json())
            .then(data => {
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = ''; 
        
                if (data.result && data.result.messages) {
                    data.result.messages.forEach(msg => {
                        addMessageToChat(msg);
                    });
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке сообщений:', error);
            });
        }
        
        function addMessageToChat(msg) {
            const messagesContainer = document.getElementById('messages');
            const div = document.createElement('div');
            div.textContent = msg.text;
        
            if (msg.sender === '{{ username }}') {
                div.style.textAlign = 'right';
                div.style.backgroundColor = '#ffe9f4';
            } else {
                div.style.textAlign = 'left';
                div.style.backgroundColor = '#cff0ec';
            }
        
            div.style.padding = '10px';
            div.style.marginBottom = '10px';
            div.style.borderRadius = '10px';
            messagesContainer.appendChild(div);
        
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addMessageToChat(msg) {
            const messagesContainer = document.getElementById('messages');
            const div = document.createElement('div');
            div.textContent = msg.text;

            if (msg.sender === '{{ username }}') {
                div.style.textAlign = 'right';
                div.style.backgroundColor = '#d3f9d8';  
            } else {
                div.style.textAlign = 'left';
                div.style.backgroundColor = '#f1f3f5';  
            }

            div.style.padding = '10px';
            div.style.marginBottom = '10px';
            div.style.borderRadius = '10px';
            messagesContainer.appendChild(div);

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const message = document.getElementById('message-input').value;
            const selectedUser = currentChatUser; 

            if (message && selectedUser) {
                fetch('/json-rpc-api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'send_message', 
                        params: { 
                            sender: '{{ username }}',  
                            receiver: selectedUser,    
                            message: message           
                        },
                        id: 5
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result) {
                        document.getElementById('message-input').value = '';  
                        addMessageToChat({
                            sender: '{{ username }}',
                            text: message
                        });
                    } else if (data.error) {
                        alert(data.error.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка при отправке сообщения:', error);
                    alert('Произошла ошибка при отправке сообщения.');
                });
            }
        }

        function reloadChat() {
            fetchUsers();

            if (currentChatUser) {
                loadMessages(currentChatUser);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            fetchUsers();

            document.getElementById('send-message').addEventListener('click', sendMessage);

            reloadChat();
        });

        document.getElementById('logout-button').addEventListener('click', function() {
            fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/rgz/logins'; 
                } else {
                    console.error('Ошибка при выходе из системы:', response.statusText);
                }
            })
            .catch(error => {
                console.error('Ошибка при выходе из системы:', error);
            });
        });

    </script>
    {%endblock%}
{% endblock %}